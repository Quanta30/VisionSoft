@page "/callclosemaster"
@inject IJSRuntime JS
@using System.Data
@rendermode InteractiveServer 

<T_Msg @ref="Msg" />
@if (isViewing)
{
    <FrmView TableName="CallCloseMaster" OnClosed="HandleClose" EditClicked="HandleEdit"/>
}

<T_Frm FormName="Call Close Master">
    <ChildContent>
        <T_Row>
            <T_Input Title="Entry No *" ReadOnly="true" @bind-Value="@model.dict["EntryNo"]" ColSize="col-md-3" />
            <T_Input Title="Entry Date" Type="date" @bind-Value="@model.dict["EntryDate"]" ColSize="col-md-3" />
            <div class="col-md-3">
                <label class="form-label">Mode of Pay *</label>
                <select class="form-control" @bind="@model.dict["ModeOfPay"]">
                    <option value="">Select Mode</option>
                    <option value="CASH">Cash</option>
                    <option value="CREDIT">Credit</option>
                    <option value="CARD">Card</option>
                    <option value="UPI">UPI</option>
                    <option value="CHEQUE">Cheque</option>
                    <option value="NEFT">NEFT</option>
                    <option value="RTGS">RTGS</option>
                    <option value="IMPS">IMPS</option>
                </select>
            </div>
            <T_Checkbox Title="Consider In Accounts" @bind-Value="@model.dict["ConsiderInAccounts"]" ColSize="col-md-3" />
        </T_Row>
        <T_Row>
            <T_RInput Title="Token ID *" @bind-Value="@model.dict["TokenID"]" ColSize="col-md-4"
                      TableName="TokenMaster" PrimaryColumn="TokenID" DisplayColumn="TokenID" />
            <T_Input Title="Completion Date" Type="date" @bind-Value="@model.dict["CompletionDate"]" ColSize="col-md-4" />
            <T_Input Title="Completion Time" Type="time" @bind-Value="@model.dict["CompletionTime"]" ColSize="col-md-4" />
        </T_Row>
        <T_Row>
            <T_Input Title="Amount *" Type="number" Step="0.01" @bind-Value="@model.dict["Amount"]" ColSize="col-md-4" />
            <T_Input Title="Discount" Type="number" Step="0.01" @bind-Value="@model.dict["Discount"]" ColSize="col-md-4" />
            <T_Input Title="Net Amount *" Type="number" Step="0.01" @bind-Value="@model.dict["NetAmount"]" ColSize="col-md-4" />
        </T_Row>
        <T_Row>
            <T_Input Title="Narration" @bind-Value="@model.dict["Narration"]" MaxLength="500" ColSize="col-md-6" />
            <T_Input Title="Closed By" @bind-Value="@model.dict["ClosedBy"]" MaxLength="50" ColSize="col-md-3" />
            <T_Checkbox Title="Cancelled" @bind-Value="@model.dict["Cancelled"]" ColSize="col-md-3" />
        </T_Row>
    </ChildContent>

    <CardFooterContent>
        <T_Button Text="Save" btnType="Save" OnClick="HandleSave" Style=""/>
        <T_Button Text="Clear" btnType="Clear" OnClick="HandleClear" Style=""/>
        <T_Button Text="View" btnType="View" OnClick="HandleView" Style=""/>
    </CardFooterContent>
</T_Frm>

@code {
    private T_Msg Msg;
    public DotNetObjectReference<CallCloseMaster> dotNetRef;

    Model model = new Model("CallCloseMaster", "EntryNo", "A");
    private bool isViewing = false;
    private bool isEditing = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if(firstRender)
        {
            Console.WriteLine("CallCloseMaster OnAfterRenderAsync executed");
            dotNetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("setupFormKeyHandler", dotNetRef);
            
            // Initialize defaults
            InitializeDefaults();
        }
    }

    protected override void OnInitialized()
    {
        // Initialize defaults when component is first created
        InitializeDefaults();
    }

    private void InitializeDefaults()
    {
        // Set default date if empty
        if (string.IsNullOrEmpty(model.dict["EntryDate"]))
            model.dict["EntryDate"] = DateTime.Now.ToString("yyyy-MM-dd");
        
        // Set default Mode of Pay to CASH
        if (string.IsNullOrEmpty(model.dict["ModeOfPay"]))
            model.dict["ModeOfPay"] = "CASH";
        
        // Initialize boolean fields
        if (string.IsNullOrEmpty(model.dict["ConsiderInAccounts"]))
            model.dict["ConsiderInAccounts"] = "1";
        
        if (string.IsNullOrEmpty(model.dict["Cancelled"]))
            model.dict["Cancelled"] = "0";
        
        // Initialize numeric fields to 0 if empty
        if (string.IsNullOrEmpty(model.dict["Amount"]))
            model.dict["Amount"] = "0.00";
        
        if (string.IsNullOrEmpty(model.dict["Discount"]))
            model.dict["Discount"] = "0.00";
        
        if (string.IsNullOrEmpty(model.dict["NetAmount"]))
            model.dict["NetAmount"] = "0.00";
    }

    [JSInvokable]
    public async Task HandleSave()
    {
        try
        {
            if (!ValidateForm()) return;

            bool success = isEditing
                ? model.Update()
                : model.Save();

            if (success)
            {
                await Msg.Success();

                if (!isEditing)
                {
                    HandleClear();
                }

                isEditing = false;
            }
            else
            {
                await Msg.SaveError();
            }
        }
        catch (Exception ex)
        {
            await Msg.SaveError();
            Console.WriteLine($"Error saving Call Close record: {ex.Message}");
        }
    }

    [JSInvokable]
    public void HandleClear()
    {
        model.Clear();
        isEditing = false;
        
        // Re-apply defaults after clearing
        InitializeDefaults();
        
        StateHasChanged();
    }

    [JSInvokable]
    public void HandleView()
    {
        isViewing = !isViewing;
        StateHasChanged();
    }

    public async Task HandleEdit(DataRow row)
    {
        try
        {
            isEditing = true;
            isViewing = false;
            
            // Clear first to ensure clean state
            model.Clear();
            
            // Populate with data
            model.Populate(row);
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading Call Close record: {ex.Message}");
            Msg.Show($"Error loading record: {ex.Message}", "danger", "bi-exclamation-triangle");
            HandleClear();
        }
    }

    public void HandleClose()
    {
        isViewing = false;
        StateHasChanged();
    }

    private bool ValidateForm()
    {
        var errors = new List<string>();

        // Required field validations
        if (string.IsNullOrWhiteSpace(model.dict["EntryNo"])) 
            errors.Add("Entry No is required");

        if (string.IsNullOrWhiteSpace(model.dict["ModeOfPay"])) 
            errors.Add("Mode of Pay is required");

        if (string.IsNullOrWhiteSpace(model.dict["TokenID"])) 
            errors.Add("Token ID is required");

        if (string.IsNullOrWhiteSpace(model.dict["Amount"])) 
            errors.Add("Amount is required");

        if (string.IsNullOrWhiteSpace(model.dict["NetAmount"])) 
            errors.Add("Net Amount is required");

        // Length validations
        if (!string.IsNullOrWhiteSpace(model.dict["EntryNo"]) && model.dict["EntryNo"].Length > 50)
            errors.Add("Entry No cannot exceed 50 characters");

        if (!string.IsNullOrWhiteSpace(model.dict["ModeOfPay"]) && model.dict["ModeOfPay"].Length > 50)
            errors.Add("Mode of Pay cannot exceed 50 characters");

        if (!string.IsNullOrWhiteSpace(model.dict["TokenID"]) && model.dict["TokenID"].Length > 50)
            errors.Add("Token ID cannot exceed 50 characters");

        if (!string.IsNullOrWhiteSpace(model.dict["Narration"]) && model.dict["Narration"].Length > 500)
            errors.Add("Narration cannot exceed 500 characters");

        if (!string.IsNullOrWhiteSpace(model.dict["ClosedBy"]) && model.dict["ClosedBy"].Length > 50)
            errors.Add("Closed By cannot exceed 50 characters");

        // Numeric validations
        if (!string.IsNullOrWhiteSpace(model.dict["Amount"]) && !double.TryParse(model.dict["Amount"], out _))
            errors.Add("Amount must be a valid number");

        if (!string.IsNullOrWhiteSpace(model.dict["Discount"]) && !double.TryParse(model.dict["Discount"], out _))
            errors.Add("Discount must be a valid number");

        if (!string.IsNullOrWhiteSpace(model.dict["NetAmount"]) && !double.TryParse(model.dict["NetAmount"], out _))
            errors.Add("Net Amount must be a valid number");

        // Date validations
        if (!string.IsNullOrWhiteSpace(model.dict["EntryDate"]) && !DateTime.TryParse(model.dict["EntryDate"], out _))
            errors.Add("Entry Date must be a valid date");

        if (!string.IsNullOrWhiteSpace(model.dict["CompletionDate"]) && !DateTime.TryParse(model.dict["CompletionDate"], out _))
            errors.Add("Completion Date must be a valid date");

        if (errors.Any())
        {
            var message = string.Join(", ", errors);
            Msg.Show(message, "danger", "bi-exclamation-triangle");
            return false;
        }

        return true;
    }

    public void Dispose()
    {
        dotNetRef?.Dispose();
    }
}